name: ğŸ” Pull Request Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

env:
  NODE_VERSION: '24.1.0'

jobs:
  # ğŸ” PR Information
  pr-info:
    name: ğŸ“‹ PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Comment PR Info
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const prInfo = `
            ## ğŸ” PR Testing Started
            
            **Branch:** \`${{ github.head_ref }}\`
            **Base:** \`${{ github.base_ref }}\`
            **Commit:** \`${{ github.sha }}\`
            
            ### ğŸ§ª Tests Running:
            - [ ] TypeScript compilation
            - [ ] ESLint checks
            - [ ] Prettier formatting
            - [ ] Unit tests
            - [ ] E2E tests
            - [ ] Security audit
            - [ ] Performance checks
            
            ---
            *This comment will be updated with test results...*
            `;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: prInfo
            });

  # ğŸš€ Quick Checks
  quick-checks:
    name: âš¡ Quick Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript check
        run: npm run type-check

      - name: ğŸ¨ Lint check
        run: npm run lint

      - name: ğŸ§¹ Format check
        run: npm run format:check

  # ğŸ§ª Comprehensive Testing
  comprehensive-tests:
    name: ğŸ§ª Comprehensive Tests
    runs-on: ubuntu-latest
    needs: quick-checks
    
    strategy:
      matrix:
        test-type: [unit, integration]
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run ${{ matrix.test-type }} tests
        run: npm run test:${{ matrix.test-type }}

      - name: ğŸ“Š Upload coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          flags: ${{ matrix.test-type }}
          name: ${{ matrix.test-type }}-coverage

  # ğŸ­ E2E Testing
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    needs: quick-checks
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps

      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL_TEST }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY_TEST }}

      - name: ğŸ­ Run E2E tests
        run: npm run test:e2e

      - name: ğŸ“¸ Upload screenshots
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

  # ğŸ” Security Checks
  security-audit:
    name: ğŸ” Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Run npm audit
        run: npm audit --audit-level moderate

      - name: ğŸ›¡ï¸ Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  # ğŸ“Š Build Size Check
  build-size:
    name: ğŸ“Š Build Size Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ“Š Analyze bundle size
        uses: preactjs/compressed-size-action@v2
        with:
          repo-token: '${{ secrets.GITHUB_TOKEN }}'
          pattern: './dist/**/*.{js,css,html}'
          exclude: '{./dist/**/*.map,./dist/**/worker-*.js}'

  # ğŸš€ Preview Deployment
  preview-deploy:
    name: ğŸš€ Preview Deployment
    runs-on: ubuntu-latest
    needs: [quick-checks, comprehensive-tests]
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for preview
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL_STAGING }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY_STAGING }}
          VITE_APP_ENVIRONMENT: preview

      - name: ğŸš€ Deploy Preview
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: ğŸ’¬ Comment Preview URL
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const previewUrl = '${{ steps.vercel-deploy.outputs.preview-url }}';
            
            const comment = `
            ## ğŸš€ Preview Deployment Ready!
            
            **Preview URL:** ${previewUrl}
            
            ### ğŸ§ª Test your changes:
            - [ ] Login/Registration flow
            - [ ] Hackathon creation
            - [ ] Team management
            - [ ] Ideas board
            - [ ] Mobile responsiveness
            
            *Preview will be automatically updated on new commits.*
            `;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: comment
            });

  # ğŸ Status Summary
  pr-status:
    name: ğŸ PR Status Summary
    runs-on: ubuntu-latest
    needs: [quick-checks, comprehensive-tests, e2e-tests, security-audit, build-size]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Status Report
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, number } = context.issue;
            
            const jobs = [
              { name: 'Quick Checks', status: '${{ needs.quick-checks.result }}' },
              { name: 'Comprehensive Tests', status: '${{ needs.comprehensive-tests.result }}' },
              { name: 'E2E Tests', status: '${{ needs.e2e-tests.result }}' },
              { name: 'Security Audit', status: '${{ needs.security-audit.result }}' },
              { name: 'Build Size', status: '${{ needs.build-size.result }}' }
            ];
            
            const getEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¹ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â³';
              }
            };
            
            const overallStatus = jobs.every(job => job.status === 'success') ? 'success' : 'failure';
            const overallEmoji = getEmoji(overallStatus);
            
            const statusReport = `
            ## ${overallEmoji} PR Test Results
            
            ### ğŸ§ª Test Summary:
            ${jobs.map(job => `- ${getEmoji(job.status)} **${job.name}**: ${job.status}`).join('\n')}
            
            ### ğŸ“‹ Next Steps:
            ${overallStatus === 'success' 
              ? 'ğŸ‰ All tests passed! This PR is ready for review.' 
              : 'ğŸ”§ Some tests failed. Please check the failed jobs and fix the issues.'}
            
            ---
            **Commit:** \`${{ github.sha }}\`
            **Workflow:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: statusReport
            });

      - name: ğŸš¦ Set PR Status
        if: needs.quick-checks.result == 'success' && needs.comprehensive-tests.result == 'success' && needs.e2e-tests.result == 'success'
        run: echo "âœ… All tests passed - PR is ready for review!"

      - name: âŒ Fail if tests failed
        if: needs.quick-checks.result == 'failure' || needs.comprehensive-tests.result == 'failure' || needs.e2e-tests.result == 'failure'
        run: |
          echo "âŒ Tests failed - please fix the issues before merging"
          exit 1
